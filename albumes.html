<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>√Ålbum</title>
<link href="https://fonts.googleapis.com/css2?family=Oxygen+Mono:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
/* ---------- CSS (tus estilos, conservados y ordenados) ---------- */
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Poppins',sans-serif;background:#f0f2f5;color:#333;}
header{background:#0077b6;color:white;padding:1rem;display:flex;align-items:center;justify-content:space-between;}
header h1{font-size:1.3rem;font-weight:600;flex-grow:1;text-align:center;}
#backBtn,#homeBtn{font-size:1.2rem;background:none;border:none;color:white;cursor:pointer;transition:all 0.5s ease;padding:0 0.5rem;}
main{max-width:800px;margin:1rem auto;padding:1rem;background:#fff;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,0.1);}
.list-item{background:#e1f0ff;border-radius:8px;padding:12px;margin-bottom:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;position:relative;}
.list-item.subfolder{background:#ffcccc;}
.list-item:hover{background:#b0d6ff;}
.list-item .menu-btn{margin-left:10px;background:none;border:none;font-size:1.2rem;cursor:pointer;position:relative;}
.submenu{display:none;position:absolute;top:40px;right:10px;background:white;border-radius:8px;box-shadow:0 3px 10px rgba(0,0,0,0.15);flex-direction:column;z-index:50;min-width:140px;}
.submenu button{border:none;background:none;padding:8px 12px;text-align:left;cursor:pointer;width:100%;font-weight:600;}
.submenu button:hover{background:#0077b6;color:white;}
.song-container{width:100%;max-width:700px;background:#ffffffee;border-radius:15px;padding:22px 18px;margin:20px auto;box-shadow:0 5px 18px rgba(0,0,0,0.07);position:relative;display:none;}
.song-container h2{text-align:center;margin-bottom:8px;font-size:1.5rem;}
.tone{cursor:pointer;font-weight:600;margin-bottom:12px;text-align:center;display:inline-block;position:relative;}
.tone:hover{color:#0077b6;text-decoration:underline;}
.tone-menu{position:absolute;top:120%;left:50%;transform:translateX(-50%) scale(0.95);background:white;border-radius:10px;display:none;flex-direction:column;box-shadow:0 6px 15px rgba(0,0,0,0.15);width:170px;opacity:0;transition:all 0.2s ease;}
.tone-menu.show{display:flex;opacity:1;transform:translateX(-50%) scale(1);}
.tone-menu button{background:white;border:none;border-bottom:1px solid #eee;padding:8px 16px;font-weight:600;color:#333;cursor:pointer;font-size:0.8rem;}
.tone-menu button:hover{background:#0077b6;color:white;}
.controls { display: grid; grid-template-columns: 1fr 1fr 1fr; align-items:center; gap:10px; width:100%; max-width:600px; margin:10px auto; }
#toneSelect, .control-btn { width:100%; height:40px; border-radius:8px; font-family:'Poppins'; font-size:clamp(10px,2.5vw,14px); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:center; cursor:pointer; padding:0 5px; box-sizing:border-box; }
.controls button, .controls select{background:#fff;border:2px solid #0077b6;color:#222;padding:7px 10px;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.8rem;transition:all 0.25s ease-in-out;}
.controls button:hover, .controls select:hover{background:#0077b6;color:#fff;transform:translateY(-1px);}
.tone-original{background:#fff3cd;border:2px solid #ffb703;color:#7a5a00;}
.navigation-buttons { margin-top:15px; width:100%; display:flex; justify-content:space-between; }
.navigation-buttons button { background:#0077b6; border:none; color:white; padding:10px 18px; border-radius:8px; font-size:1rem; cursor:pointer; transition:background .3s ease; }
.navigation-buttons button:hover { background:#005f8b; }
#songLyrics { font-family:'Oxygen Mono', monospace !important; font-size:clamp(12px,2vw,16px); line-height:1.35; font-weight:700 !important; white-space:pre-wrap; overflow-wrap:break-word; color:#222; text-align:left; width:100%; max-width:100%; min-width:0; background:none; border:none; padding:0; margin-top:60px; }
.chord { font-weight:700 !important; color:#0077b6; font-family:inherit; font-size:inherit; white-space:normal; display:inline; cursor:pointer; letter-spacing:0.01em; }
.chord:hover { color:#ffb703; }
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background: rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:100;}
.modal-content{background:white;border-radius:12px;padding:20px;width:85%;max-width:400px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.2);}
.modal-content select{width:100%;margin-bottom:12px;padding:7px;}
.modal-buttons{display:flex;justify-content:space-between;margin-top:10px;}
.chord-preview{position:fixed;bottom:18px;right:18px;background:#fff;border:2px solid #0077b6;border-radius:10px;padding:7px 14px;color:#222;font-weight:600;font-size:0.85rem;display:none;box-shadow:0 3px 10px rgba(0,0,0,0.15);}
.floating-add{position:fixed;bottom:20px;right:20px;background:#0077b6;color:white;padding:12px 18px;border-radius:50%;font-size:1.2rem;cursor:pointer;box-shadow:0 3px 15px rgba(0,0,0,0.2);}
#homeBtn{background:none;cursor:pointer;font-size:1.5rem;color:white;margin-left:0.5rem;}
.swal2-popup-custom { font-family: 'Poppins', sans-serif; font-size:1rem; border-radius:15px !important; color:#212529; }
.back-song-btn {
  position: absolute;
  top: 12px;     /* un poco m√°s arriba */
  left: 8px;     /* m√°s a la izquierda */
  width: 38px;
  height: 38px;
  border: none;
  border-radius: 50%;
  background: linear-gradient(145deg, #2196f3, #1565c0);
  color: white;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  transition: all 0.25s ease;
  z-index: 20;
}

.back-song-btn::before {
  content: "‚Üê";
}

.back-song-btn:hover {
  transform: scale(1.12);
  background: linear-gradient(145deg, #42a5f5, #1e88e5);
  box-shadow: 0 5px 12px rgba(0, 0, 0, 0.35);
}

/* ---------- fin CSS ---------- */
</style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<header>
  <button id="backBtn" title="Atr√°s">‚Üê</button>
  <button id="homeBtn" title="Volver al inicio">üè†</button>
  <h1 id="albumTitle">Cargando √°lbum...</h1>
</header>

<main>
  <section id="foldersList"></section>
  <section id="albumSongsList"></section>
  <section id="songsList" style="display:none;"></section>

  <section id="songContent" class="song-container" aria-hidden="true">
    <button id="closeSongBtn" class="back-song-btn" style="display:none;"></button>
    <h2 id="songTitle"></h2>

    <div class="tone" id="tone">
      üéµ Tono actual: <span id="toneValue"></span>
      <div class="tone-menu" id="toneMenu">
        <button onclick="transposeHalf(1)">üîº Subir ¬Ω tono</button>
        <button onclick="transposeTone(1)">üîº Subir 1 tono</button>
        <button onclick="transposeHalf(-1)">üîΩ Bajar ¬Ω tono</button>
        <button onclick="transposeTone(-1)">üîΩ Bajar 1 tono</button>
        <button onclick="resetTone()">üéµ Tono original</button>
      </div>
    </div>

    <div class="controls" style="display:flex; align-items:center; gap:10px;">
      <select id="toneSelect" class="control-btn"></select>
      <button class="control-btn tone-original" id="btnOriginalTone">üéµ Tono original</button>
      <button class="control-btn" id="autoScrollToggleBtn">‚ñ∂ Desplazar</button>
    </div>

    <pre id="songLyrics"></pre>

    <div class="navigation-buttons">
      <button id="songBackBtn">‚Üê Anterior</button>
      <button id="nextSongBtn">Siguiente ‚Üí</button>
    </div>
  </section>
</main>

<!-- control scroll -->
<div id="scrollControlBar" style="position:fixed;bottom:0;left:0;right:0;background:#f9fbfd;border-top:2px solid #0077b6;padding:12px 20px;display:none;flex-direction:column;align-items:center;gap:12px;box-shadow:0 -4px 12px rgba(0,119,182,.2);z-index:9999;">
  <label for="scrollSpeed" style="font-weight:600;color:#0077b6;">Velocidad:</label>
  <input type="range" id="scrollSpeed" min="1" max="10" value="1" step="1" style="width:90%;">
  <button id="stopScrollBtn" style="width:90%;background:#dc3545;color:#fff;border:none;padding:10px 0;border-radius:8px;cursor:pointer;font-weight:700;">‚èπÔ∏è Detener</button>
</div>

<div class="modal" id="moveModal">
  <div class="modal-content">
    <h3>Mover a carpeta</h3>
    <select id="folderSelect"></select>
    <div class="modal-buttons">
      <button id="cancelMove">Cancelar</button>
      <button id="confirmMove">Mover</button>
    </div>
  </div>
</div>

<div class="chord-preview" id="chordPreview"></div>
<div class="floating-add" id="createAlbumBtn" title="Crear carpeta">‚ûï</div>

<script type="module">
/* ========== JS: funcional y completo ========== */
/* IMPORT FIREBASE (modular) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ----- CONFIG FIREBASE (usa tu config) ----- */
const firebaseConfig = {
  apiKey: "AIzaSyBt48uLSA1IhO36jXTbdOh7o-O8zQ2VAQ4",
  authDomain: "roca-fuerte-79965.firebaseapp.com",
  projectId: "roca-fuerte-79965",
  storageBucket: "roca-fuerte-79965.appspot.com",
  messagingSenderId: "997970282203",
  appId: "1:997970282203:web:e2dcb13d7be47d753eeefe"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ----- Datos y elementos ----- */
const scale = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B",
  "Cm","C#m","Dm","D#m","Em","Fm","F#m","Gm","G#m","Am","A#m","Bm"];

const albumTitleEl = document.getElementById('albumTitle');
const backBtn = document.getElementById('backBtn');
const homeBtn = document.getElementById('homeBtn');
homeBtn.addEventListener('click', () => {
  window.location.href = 'index.html';
});
const foldersList = document.getElementById('foldersList');
const albumSongsList = document.getElementById('albumSongsList');
const songsList = document.getElementById('songsList');
const songContent = document.getElementById('songContent');
const songBackBtn = document.getElementById('songBackBtn');
const nextSongBtn = document.getElementById('nextSongBtn');
const songTitleEl = document.getElementById('songTitle');
const songLyricsEl = document.getElementById('songLyrics');
const toneValueEl = document.getElementById('toneValue');
const toneSelect = document.getElementById('toneSelect');
const moveModal = document.getElementById('moveModal');
const folderSelect = document.getElementById('folderSelect');
const confirmMove = document.getElementById('confirmMove');
const cancelMove = document.getElementById('cancelMove');
const createAlbumBtn = document.getElementById('createAlbumBtn');
const chordPreview = document.getElementById('chordPreview');
const closeSongBtn = document.getElementById('closeSongBtn');

const autoScrollToggleBtn = document.getElementById('autoScrollToggleBtn');
const scrollControlBar = document.getElementById('scrollControlBar');
const scrollSpeedInput = document.getElementById('scrollSpeed');
const stopScrollBtn = document.getElementById('stopScrollBtn');

let currentUser = null, userData = null, currentAlbum = null, currentFolder = null;
let songsDB = [], currentSong = null, currentSongIndex = -1, currentSongList = [], originalTone = null, currentTone = null;
let navigationStack = []; // historial { type: 'album'|'folder'|'song', album?, folder?, song? }

/* ---------- utilidades ---------- */
function showElement(el){ if(el) el.style.display='block'; }
function hideElement(el){ if(el) el.style.display='none'; }

/* ---------- cargar canciones locales (opcional) ---------- */
/* Si tus letras/ acordes est√°n en songs.json y quieres usarlas, descomenta la l√≠nea de abajo.
   Si todo lo guardas en Firestore (userData.albums.songs con title/chords/lyrics/tone) no hace falta. */
async function loadSongsJson(){
  try {
    const res = await fetch('songs.json');
    if(res.ok) songsDB = await res.json();
  } catch(e){ console.warn('No hay songs.json o fallo al cargarlo'); }
}

/* ---------- FIRESTORE: cargar datos de usuario ---------- */
async function loadUserData(uid){
  const docSnap = await getDoc(doc(db, 'users', uid));
  return docSnap.exists() ? docSnap.data() : null;
}
async function updateUserData(){
  if(currentUser && userData) {
    await updateDoc(doc(db, 'users', currentUser.uid), { albums: userData.albums });
  }
}

/* ---------- menus contextuales para carpetas ---------- */
function createFolderMenu(folder, refreshCb){
  const menu = document.createElement('div');
  menu.className = 'submenu';
  menu.style.flexDirection = 'column';

  const renameBtn = document.createElement('button');
  renameBtn.textContent = 'Renombrar';
  renameBtn.onclick = e => {
    e.stopPropagation();
    Swal.fire({
      title: 'Renombrar Carpeta',
      input: 'text',
      inputLabel: 'Nuevo nombre',
      inputValue: folder.name,
      showCancelButton: true,
      confirmButtonText: 'Guardar',
      cancelButtonText: 'Cancelar',
      inputAttributes: { autocapitalize: 'off' },
      customClass: { popup: 'swal2-popup-custom' }
    }).then(result => {
      if(result.isConfirmed){
        const newName = result.value.trim();
        if(newName){
          folder.name = newName;
          updateUserData().then(()=>refreshCb());
        } else {
          Swal.fire({ icon:'error', title:'Error', text:'El nombre no puede estar vac√≠o', confirmButtonColor:'#0077b6' });
        }
      }
      menu.style.display='none';
    });
  };

  const deleteBtn = document.createElement('button');
  deleteBtn.textContent = 'Eliminar';
  deleteBtn.onclick = e => {
    e.stopPropagation();
    Swal.fire({
      icon:'warning',
      title:'¬øEliminar carpeta?',
      text:'Esta acci√≥n no puede revertirse',
      showCancelButton:true,
      confirmButtonText:'S√≠, eliminar',
      cancelButtonText:'Cancelar'
    }).then(result=>{
      if(result.isConfirmed){
        // eliminar correcto seg√∫n contenedor
        const parentContext = navigationStack.length === 0 ? 'root' : (currentFolder ? 'folder' : 'root');
        if(parentContext === 'root'){
          const idx = currentAlbum.folders.indexOf(folder);
          if(idx>-1) currentAlbum.folders.splice(idx,1);
        } else if(currentFolder && currentFolder.folders){
          const idx = currentFolder.folders.indexOf(folder);
          if(idx>-1) currentFolder.folders.splice(idx,1);
        }
        updateUserData().then(()=>refreshCb());
      }
    });
    menu.style.display='none';
  };

  menu.append(renameBtn, deleteBtn);
  menu.style.display='none';
  return menu;
}

/* ---------- RENDER VIEWS ---------- */
function renderAlbumView(){
  foldersList.innerHTML = '';
  albumSongsList.innerHTML = '';
  songsList.style.display = 'none';
  hideElement(songContent);

  backBtn.style.display = navigationStack.length > 0 ? 'inline-block' : 'none';
  albumTitleEl.textContent = currentAlbum.name || '√Ålbum';

  showElement(foldersList);
  showElement(albumSongsList);

  createAlbumBtn.style.display = currentFolder ? 'none' : 'block';

  // carpetas ra√≠z
  if(currentAlbum.folders && currentAlbum.folders.length > 0){
    currentAlbum.folders.forEach(folder=>{
      const div = document.createElement('div');
      div.className = 'list-item subfolder';
      div.innerHTML = `${folder.name} <span style="font-weight:600;color:#7a0000;">(Carpeta)</span>`;
      div.onclick = () => {
        navigationStack.push({ type:'album', album: currentAlbum });
        currentFolder = folder;
        renderFolderView(folder);
      };

      const menuBtn = document.createElement('button');
      menuBtn.className = 'menu-btn';
      menuBtn.textContent = '‚ãÆ';

      const submenu = createFolderMenu(folder, ()=>renderAlbumView());
      div.appendChild(menuBtn);
      div.appendChild(submenu);
      menuBtn.onclick = e => { e.stopPropagation(); submenu.style.display = submenu.style.display === 'flex' ? 'none' : 'flex'; };

      foldersList.appendChild(div);
    });
  } else {
    foldersList.innerHTML = '<p style="text-align:center;color:#555;">No hay carpetas en este √°lbum</p>';
  }

  // canciones en ra√≠z del √°lbum
  if(currentAlbum.songs && currentAlbum.songs.length > 0){
    currentAlbum.songs.forEach((song, idx)=>{
      const div = document.createElement('div');
      div.className = 'list-item';
      div.textContent = song.title + (song.tone ? ` (${song.tone})` : '');

      const menuBtn = document.createElement('button');
      menuBtn.className='menu-btn'; menuBtn.textContent='‚ãÆ';

      const submenu = document.createElement('div'); submenu.className='submenu'; submenu.style.flexDirection='column';

      const moveUp = document.createElement('button'); moveUp.textContent='Mover arriba';
      moveUp.onclick = e => { e.stopPropagation(); if(idx===0){ Swal.fire({icon:'info', title:'¬°Atenci√≥n!', text:'La canci√≥n ya est√° en la primera posici√≥n.'}); submenu.style.display='none'; return; } [currentAlbum.songs[idx-1], currentAlbum.songs[idx]]=[currentAlbum.songs[idx], currentAlbum.songs[idx-1]]; updateUserData().then(()=>renderAlbumView()); submenu.style.display='none'; };
      const moveDown = document.createElement('button'); moveDown.textContent='Mover abajo';
      moveDown.onclick = e => { e.stopPropagation(); if(idx===currentAlbum.songs.length-1){ Swal.fire({icon:'info', title:'¬°Atenci√≥n!', text:'La canci√≥n ya est√° en la √∫ltima posici√≥n.'}); submenu.style.display='none'; return; } [currentAlbum.songs[idx+1], currentAlbum.songs[idx]]=[currentAlbum.songs[idx], currentAlbum.songs[idx+1]]; updateUserData().then(()=>renderAlbumView()); submenu.style.display='none'; };
      const deleteBtn = document.createElement('button'); deleteBtn.textContent='Eliminar';
      deleteBtn.onclick = e => { e.stopPropagation(); Swal.fire({ icon:'warning', title:'¬øEliminar canci√≥n?', text:'Esta acci√≥n no puede revertirse', showCancelButton:true, confirmButtonText:'S√≠, eliminar', cancelButtonText:'Cancelar' }).then(result=>{ if(result.isConfirmed){ currentAlbum.songs.splice(idx,1); updateUserData().then(()=>renderAlbumView()); }}); submenu.style.display='none'; };
      const moveToFolderBtn=document.createElement('button'); moveToFolderBtn.textContent='Mover a carpeta';
      moveToFolderBtn.onclick = e => { e.stopPropagation(); showMoveModal(song.title); submenu.style.display='none'; };

      submenu.append(moveUp, moveDown, deleteBtn, moveToFolderBtn);
      div.append(menuBtn, submenu);
      menuBtn.onclick = e => { e.stopPropagation(); submenu.style.display = submenu.style.display === 'flex' ? 'none' : 'flex'; };
      div.onclick = () => openSong(song, currentAlbum.songs); // canci√≥n en ra√≠z
      albumSongsList.appendChild(div);
    });
  }
}

function renderFolderView(folder){
  foldersList.innerHTML = '';
  songsList.innerHTML = '';
  albumSongsList.style.display='none';
  hideElement(songContent);

  backBtn.style.display = 'inline-block';
  albumTitleEl.textContent = `${currentAlbum.name || ''} / ${getFolderPath()}`;
  showElement(foldersList); showElement(songsList);
  createAlbumBtn.style.display = 'none';

  // subcarpetas
  if(folder.folders && folder.folders.length > 0){
    folder.folders.forEach(subfolder=>{
      const div = document.createElement('div');
      div.className='list-item subfolder';
      div.innerHTML = `${subfolder.name} <span style="font-weight:600;color:#7a0000;">(Subcarpeta)</span>`;
      div.onclick = () => {
        navigationStack.push({ type:'folder', folder: currentFolder, album: currentAlbum });
        currentFolder = subfolder;
        renderFolderView(subfolder);
      };
      const menuBtn=document.createElement('button'); menuBtn.className='menu-btn'; menuBtn.textContent='‚ãÆ';
      const submenu=createFolderMenu(subfolder, ()=>renderFolderView(folder));
      div.append(menuBtn, submenu);
      menuBtn.onclick = e => { e.stopPropagation(); submenu.style.display = submenu.style.display === 'flex' ? 'none' : 'flex'; };
      songsList.appendChild(div);
    });
  }

  // canciones en la carpeta actual
  if(!folder.songs || folder.songs.length===0){
    songsList.innerHTML += '<p style="text-align:center;color:#555;">No hay canciones en esta carpeta</p>';
  } else {
    folder.songs.forEach((song, idx)=>{
      const div = document.createElement('div');
      div.className='list-item';
      div.textContent = song.title + (song.tone ? ` (${song.tone})` : '');
      const menuBtn=document.createElement('button'); menuBtn.className='menu-btn'; menuBtn.textContent='‚ãÆ';
      const submenu=document.createElement('div'); submenu.className='submenu'; submenu.style.flexDirection='column';

      const moveUpBtn=document.createElement('button'); moveUpBtn.textContent='Mover arriba';
      moveUpBtn.onclick = e => { e.stopPropagation(); if(idx===0){ Swal.fire({icon:'info', title:'¬°Atenci√≥n!', text:'La canci√≥n ya est√° en la primera posici√≥n.'}); submenu.style.display='none'; return; } [folder.songs[idx-1], folder.songs[idx]]=[folder.songs[idx], folder.songs[idx-1]]; updateUserData().then(()=>renderFolderView(folder)); submenu.style.display='none'; };
      const moveDownBtn=document.createElement('button'); moveDownBtn.textContent='Mover abajo';
      moveDownBtn.onclick = e => { e.stopPropagation(); if(idx===folder.songs.length-1){ Swal.fire({icon:'info', title:'¬°Atenci√≥n!', text:'La canci√≥n ya est√° en la √∫ltima posici√≥n.'}); submenu.style.display='none'; return; } [folder.songs[idx+1], folder.songs[idx]]=[folder.songs[idx], folder.songs[idx+1]]; updateUserData().then(()=>renderFolderView(folder)); submenu.style.display='none'; };
      const deleteBtn=document.createElement('button'); deleteBtn.textContent='Eliminar';
      deleteBtn.onclick = e => { e.stopPropagation(); Swal.fire({ icon:'warning', title:'¬øEliminar canci√≥n?', text:'Esta acci√≥n no puede revertirse', showCancelButton:true, confirmButtonText:'S√≠, eliminar', cancelButtonText:'Cancelar' }).then(result=>{ if(result.isConfirmed){ folder.songs.splice(idx,1); updateUserData().then(()=>renderFolderView(folder)); }}); submenu.style.display='none'; };
      const moveToFolderBtn=document.createElement('button'); moveToFolderBtn.textContent='Mover a carpeta';
      moveToFolderBtn.onclick = e => { e.stopPropagation(); showMoveModal(song.title); submenu.style.display='none'; };

      submenu.append(moveUpBtn, moveDownBtn, deleteBtn, moveToFolderBtn);
      div.append(menuBtn, submenu);
      menuBtn.onclick = e => { e.stopPropagation(); submenu.style.display = submenu.style.display === 'flex' ? 'none' : 'flex'; };

      // abrir canci√≥n desde carpeta (importante: pasamos folder.songs como lista)
      div.onclick = () => openSong(song, folder.songs);

      songsList.appendChild(div);
    });
  }
}

function getFolderPath(){
  let parts = [];
  let temp = currentFolder;
  while(temp){
    parts.unshift(temp.name);
    // intenta encontrar el padre examinando navigationStack (si lo guardaste)
    const back = navigationStack.slice().reverse().find(n => n.type === 'folder' && n.folder && n.folder.folders && n.folder.folders.includes(temp));
    temp = back ? back.folder : null;
  }
  return parts.join(' / ');
}

/* ---------- RENDER LYRICS & CHORDS ---------- */
function renderLyrics(lyrics){
  // lyrics es array de l√≠neas (o string)
  if(!lyrics) { songLyricsEl.innerHTML = ''; return; }
  const lines = Array.isArray(lyrics) ? lyrics : (typeof lyrics === 'string' ? lyrics.split('\n') : []);
  const chordRegex = /(?<![a-zA-Z0-9])([A-G](?:#|b)?(?:m|maj|min|dim|aug|sus2|sus4|add9|add11|m7|7|9|11|13|m9|m11|m13|maj7|maj9|maj13)?(?:\/[A-G](?:#|b)?)?)(?![a-zA-Z0-9])/g;
  songLyricsEl.innerHTML = lines.map(line => line.replace(chordRegex, match => `<span class="chord" onclick="showChordPreview('${match}')">${match}</span>`)).join('\n');
}

window.showChordPreview = chord => {
  chordPreview.innerText = `üé∏ ${chord}`;
  chordPreview.style.display = 'block';
  setTimeout(()=> chordPreview.style.display='none', 1600);
};

/* ---------- TRANSPOSICI√ìN ---------- */
function transposeChord(chord, semitones){
  const notes = ["C","C#","D","Eb","E","F","F#","G","Ab","A","Bb","B"];
  const noteMap = {"Db":"C#","D#":"Eb","Gb":"F#","G#":"Ab","A#":"Bb","Cb":"B","Fb":"E","E#":"F","B#":"C"};
  return chord.replace(/([A-G](?:#|b)?)(.*)/, (m, root, suffix)=>{
    root = noteMap[root] || root;
    const i = notes.indexOf(root);
    if(i===-1) return m;
    const ni = (i + semitones + 12) % 12;
    return notes[ni] + suffix;
  });
}

function transpose(lines, from, to){
  const semitones = (scale.indexOf(to) - scale.indexOf(from) + 12) % 12;
  return lines.map(l => l.replace(/([A-G][#b]?(?:m|maj7|sus|sus2|sus4|add9|dim|aug|7)?)/g, c => transposeChord(c, semitones)));
}

function transposeHalf(d){
  const idx = (scale.indexOf(currentTone) + d + 12) % 12;
  currentTone = scale[idx];
  toneSelect.value = currentTone;
  toneValueEl.textContent = currentTone;
  const songInfo = findSongInfo(currentSong) || { chords: [], lyrics: [], tone: 'C' };
  renderLyrics(transpose(songInfo.chords || songInfo.lyrics || [], originalTone, currentTone));
}
function transposeTone(d){ transposeHalf(2*d); }
function resetTone(){
  currentTone = originalTone;
  toneSelect.value = currentTone;
  toneValueEl.textContent = currentTone;
  const songInfo = findSongInfo(currentSong) || { chords: [], lyrics: [], tone: 'C' };
  renderLyrics(transpose(songInfo.chords || songInfo.lyrics || [], originalTone, currentTone));
}

/* ---------- ayuda para buscar canci√≥n en DB local o Firestore album structure ---------- */
function findSongInfo(song){
  // prioriza songsDB (local) si coincide por t√≠tulo, sino usa el objeto song (que puede venir desde Firestore)
  if(!song) return null;
  const found = songsDB.find(s => s.title === song.title);
  if(found) return found;
  // si el objeto song contiene chords/lyrics/tone, devu√©lvelo
  return song.chords || song.lyrics || song.tone ? song : null;
}

/* ---------- OPEN SONG: UNIFICADA y segura ---------- */
function openSong(song, songArray){
  // Push en la pila para poder volver: guardamos contexto actual (folder si existe)
  navigationStack.push({ type: 'song', folder: currentFolder, album: currentAlbum, song: song });

  currentSong = song;
  currentSongList = songArray || [];
  currentSongIndex = currentSongList.findIndex(s => s.title === song.title);

  const songInfo = findSongInfo(song) || { chords: [], lyrics: [], tone: (song && song.tone) || 'C' };
  originalTone = songInfo.tone || 'C';
  currentTone = song.tone || originalTone;

  // t√≠tulo
  songTitleEl.textContent = songInfo.title || song.title || '';

  // rellenar select de tonos
  toneSelect.innerHTML = '';
  scale.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t; opt.textContent = t;
    // enharmonic mapping (si quieres) -- simplificado: selecciona por igualdad
    if(t === currentTone) opt.selected = true;
    toneSelect.appendChild(opt);
  });

  // render acordes/letra
  const lyricsLines = songInfo.chords || songInfo.lyrics || [];
  renderLyrics(transpose(Array.isArray(lyricsLines) ? lyricsLines : (typeof lyricsLines === 'string' ? lyricsLines.split('\n') : []), originalTone, currentTone));

  toneValueEl.textContent = currentTone;

  // mostrar vista canci√≥n y ocultar listas
  showElement(songContent);
  hideElement(foldersList);
  hideElement(albumSongsList);
  hideElement(songsList);
  closeSongBtn.style.display = 'inline-block';
  songContent.setAttribute('aria-hidden', 'false');

  // onchange del selector de tonos
  toneSelect.onchange = () => {
    currentTone = toneSelect.value;
    toneValueEl.textContent = currentTone;
    const sInfo = findSongInfo(currentSong) || { chords: [], lyrics: [], tone: originalTone };
    renderLyrics(transpose(Array.isArray(sInfo.chords) ? sInfo.chords : (sInfo.lyrics || []).split('\n'), originalTone, currentTone));
  };
}

/* ---------- Cerrar canci√≥n: volver a carpeta o √°lbum ---------- */
closeSongBtn.addEventListener('click', () => {
  hideElement(songContent);
  closeSongBtn.style.display = 'none';
  songContent.setAttribute('aria-hidden', 'true');

  // si estaba dentro de una carpeta, volver a ella, sino al √°lbum
  if(currentFolder){
    renderFolderView(currentFolder);
  } else {
    renderAlbumView();
  }
});

/* ---------- botones Prev/Next dentro de la canci√≥n ---------- */
songBackBtn.addEventListener('click', () => {
  if(!currentSongList || currentSongList.length===0){ Swal.fire({icon:'info', title:'Atenci√≥n', text:'No hay canciones para retroceder.'}); return; }
  if(currentSongIndex <= 0){ Swal.fire({icon:'info', title:'Info', text:'Ya llegaste a la primera canci√≥n.'}); return; }
  currentSongIndex--;
  openSong(currentSongList[currentSongIndex], currentSongList);
});
nextSongBtn.addEventListener('click', () => {
  if(!currentSongList || currentSongList.length===0){ Swal.fire({icon:'info', title:'Atenci√≥n', text:'No hay canciones para avanzar.'}); return; }
  if(currentSongIndex >= currentSongList.length - 1){ Swal.fire({icon:'info', title:'Info', text:'Ya llegaste a la √∫ltima canci√≥n.'}); return; }
  currentSongIndex++;
  openSong(currentSongList[currentSongIndex], currentSongList);
});

/* ---------- backBtn (historial navigationStack) ---------- */
backBtn.addEventListener('click', () => {
  if(navigationStack.length === 0) return;
  const prev = navigationStack.pop();

  // Si ven√≠as desde una canci√≥n -> ir a su carpeta/album
  if(prev.type === 'song'){
    if(prev.folder){
      currentFolder = prev.folder;
      renderFolderView(prev.folder);
    } else {
      currentFolder = null;
      renderAlbumView();
    }
    return;
  }

  // Si ven√≠as desde una carpeta -> ir a su padre guardado en stack
  if(prev.type === 'folder'){
    if(prev.folder){
      currentFolder = prev.folder;
      renderFolderView(prev.folder);
    } else {
      currentFolder = null;
      renderAlbumView();
    }
    return;
  }

  // Si ven√≠as del √°lbum
  if(prev.type === 'album'){
    currentFolder = null;
    currentAlbum = prev.album || currentAlbum;
    renderAlbumView();
    return;
  }
});

/* ---------- Modal mover canci√≥n entre carpetas ---------- */
function showMoveModal(songTitle){
  moveModal.style.display = 'flex';
  folderSelect.innerHTML = '';
  function appendFolders(folders, prefix=''){
    (folders||[]).forEach(f=>{
      const opt = document.createElement('option');
      opt.value = f.name;
      opt.textContent = prefix + f.name;
      folderSelect.appendChild(opt);
      if(f.folders && f.folders.length > 0) appendFolders(f.folders, prefix + '‚Äî ');
    });
  }
  if(currentAlbum.folders) appendFolders(currentAlbum.folders);
  confirmMove.onclick = () => {
    const selected = folderSelect.value;
    function findFolderByName(folders, name){
      for(const f of folders){
        if(f.name === name) return f;
        if(f.folders && f.folders.length > 0){
          const found = findFolderByName(f.folders, name);
          if(found) return found;
        }
      }
      return null;
    }
    const targetFolder = findFolderByName(currentAlbum.folders || [], selected);
    if(!targetFolder) return;
    function removeSongFromList(list){
      const idx = list.findIndex(s => s.title === songTitle);
      if(idx > -1) return list.splice(idx,1)[0];
      return null;
    }
    let songObj = removeSongFromList(currentAlbum.songs || []);
    function removeSongFromFolders(folders){
      for(const folder of folders){
        if(folder.songs){
          const removed = removeSongFromList(folder.songs);
          if(removed) return removed;
        }
        if(folder.folders){
          const removed = removeSongFromFolders(folder.folders);
          if(removed) return removed;
        }
      }
      return null;
    }
    if(!songObj && currentAlbum.folders) songObj = removeSongFromFolders(currentAlbum.folders);
    if(songObj){
      if(!targetFolder.songs) targetFolder.songs = [];
      targetFolder.songs.push(songObj);
      updateUserData().then(()=>{ renderAlbumView(); moveModal.style.display='none'; });
    }
  };
  cancelMove.onclick = () => moveModal.style.display = 'none';
}

/* ---------- crear carpeta en ra√≠z ---------- */
createAlbumBtn.addEventListener('click', async () => {
  if(currentFolder){
    Swal.fire({icon:'info', title:'Atenci√≥n', text:'Solo puedes crear carpetas en la ra√≠z del √°lbum'});
    return;
  }
  const { value: folderName } = await Swal.fire({
    title: 'Crear carpeta',
    input: 'text',
    inputLabel: 'Nombre de la carpeta',
    inputPlaceholder: 'Ingresa nombre',
    showCancelButton: true
  });
  if(folderName && folderName.trim() !== ''){
    if(!currentAlbum.folders) currentAlbum.folders = [];
    currentAlbum.folders.push({ name: folderName.trim(), songs: [], folders: [] });
    await updateUserData();
    renderAlbumView();
  }
});

/* ---------- AUTO SCROLL ---------- */
let scrollInterval = null;
let isPaused = false;

autoScrollToggleBtn.addEventListener('click', () => {
  if(scrollControlBar.style.display === 'flex'){
    stopScrolling();
    scrollControlBar.style.display = 'none';
    autoScrollToggleBtn.textContent = '‚ñ∂ Desplazar';
  } else {
    scrollControlBar.style.display = 'flex';
    autoScrollToggleBtn.textContent = '‚è∏ Pausar';
    startScrolling();
  }
});

stopScrollBtn.addEventListener('click', () => {
  stopScrolling();
  scrollControlBar.style.display = 'none';
  autoScrollToggleBtn.textContent = '‚ñ∂ Desplazar';
});

scrollSpeedInput.addEventListener('input', () => {
  if(scrollInterval){
    stopScrolling();
    startScrolling();
  }
});

function startScrolling(){
  if(scrollInterval) return;
  const speedValue = Number(scrollSpeedInput.value);
  let speed = 0.5 + (speedValue-1) * 0.5; // escala simple
  let scrollDuration = 2000;
  let pauseDuration = 4000;
  function scrollCycle(){
    if(isPaused) return;
    let elapsed = 0;
    scrollInterval = setInterval(()=>{
      window.scrollBy(0, speed);
      elapsed += 30;
      if(elapsed >= scrollDuration){
        clearInterval(scrollInterval);
        scrollInterval = null;
        setTimeout(()=>{
          if((window.innerHeight + window.scrollY) < document.body.offsetHeight && !isPaused){
            scrollCycle();
          } else {
            stopScrolling();
            scrollControlBar.style.display='none';
            autoScrollToggleBtn.textContent = '‚ñ∂ Desplazar';
          }
        }, pauseDuration);
      }
      if((window.innerHeight + window.scrollY) >= document.body.offsetHeight){
        stopScrolling();
        scrollControlBar.style.display='none';
        autoScrollToggleBtn.textContent = '‚ñ∂ Desplazar';
      }
    }, 30);
  }
  scrollCycle();
}
function stopScrolling(){
  isPaused = true;
  if(scrollInterval) { clearInterval(scrollInterval); scrollInterval = null; }
  setTimeout(()=> isPaused = false, 300);
}

/* ---------- INICIO: auth y carga ---------- */
onAuthStateChanged(auth, async (user) => {
  if(user){
    currentUser = user;
    await loadSongsJson(); // optional; no falla si no existe
    userData = await loadUserData(user.uid);
    if(!userData) userData = { albums: [] };
    if(!userData.albums) userData.albums = [];

    const albumParam = new URLSearchParams(window.location.search).get('album');
    currentAlbum = albumParam ? userData.albums.find(a => a.name === albumParam) : userData.albums[0];

    if(!currentAlbum){
      currentAlbum = { name: 'Nuevo √Ålbum', songs: [], folders: [] };
      userData.albums.push(currentAlbum);
      await updateUserData();
    }

    currentFolder = null;
    navigationStack = [];
    renderAlbumView();
  } else {
    // no logueado -> enviar a login
    window.location.href = 'login.html';
  }
});

/* ---------- Evitar duplicados y errores ---------- */
/* Ten en cuenta: si copias este archivo en tu proyecto y ya tienes funciones/variables con el mismo nombre en otro <script>,
   puede causar conflictos. Usa este archivo como la √∫nica fuente de control JS para esta p√°gina. */

/* ---------- FIN ---------- */
</script>
</body>
</html>
