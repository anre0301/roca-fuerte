<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Afinador ‚Äî NotaClave</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --fondo1:#eaf8ff; --fondo2:#cfeaff;
      --azul:#009eff; --azulOscuro:#0074d9;
      --verde:#00c776; --rojo:#ff4b4b; --amarillo:#ffd166;
      --blanco:rgba(255,255,255,0.97); --muted:#75869d;
      --radio:14px; --sombra: 0 6px 20px rgba(16,24,40,0.08);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{min-height:100vh;font-family:'Poppins',system-ui;background:linear-gradient(180deg,var(--fondo1),var(--fondo2));color:#102a43}
    .wrap{max-width:520px;margin:22px auto 0 auto;padding:18px;}
    header{
      display:flex; align-items:center; gap:12px;
      background:linear-gradient(90deg,var(--azul),var(--azulOscuro));
      color:#fff; padding:14px 20px; border-radius:var(--radio); box-shadow:var(--sombra);
      position:relative; margin-bottom:18px;
    }
    .back-btn{font-size:1.7rem; margin-right:14px; color:#fff; text-decoration:none;
      background:rgba(255,255,255,0.09); border:none; border-radius:50%; width:38px;height:38px;display:flex;align-items:center;justify-content:center; transition:background .15s;}
    .back-btn:hover{background:rgba(255,255,255,0.19);}
    header h1{font-size:1.18rem;font-weight:700;margin:0;flex:1;}

    .strings-bar {display:flex;gap:10px;justify-content:center;margin: 0 0 18px 0;}
    .string-btn{
      width:40px;height:40px;background:linear-gradient(90deg,#fff,#d6ecfa);
      border:2px solid #90b4d4;border-radius:10px;font-weight:800;
      color:var(--azulOscuro);font-size:1rem;display:flex;flex-direction:column;
      align-items:center;justify-content:center;gap:2px;cursor:pointer;transition:box-shadow .18s, border .18s;font-family:inherit;
    }
    .string-btn.selected {border:2.5px solid var(--azul);box-shadow:0 3px 10px #70c0ff33;}

    .main-card{background:var(--blanco);border-radius:var(--radio);padding:22px 22px 19px;box-shadow:var(--sombra);}
    .controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
    .btn{background:linear-gradient(90deg,var(--azul),var(--azulOscuro));color:#fff;font-weight:700;padding:8px 16px;border:none;border-radius:10px;cursor:pointer;
      transition:background .16s; font-size:1rem;}
    .btn.ghost{background:transparent;color:var(--muted);border:1.4px solid #cbd5e1;}
    .btn:hover{opacity:0.92;}
    .note-big{font-size:2.15rem;font-weight:800;margin-top:6px;letter-spacing:2px;}
    .freq{color:var(--muted); font-size:0.97rem;}
    .tuner{text-align:center;}

    .gauge{width:94%;max-width:350px;height:14px;margin:18px auto 0; border-radius:12px;background:#e6edf3;position:relative;overflow:hidden}
    .gauge .mark{position:absolute;left:50%;top:-10px;width:2.5px;height:38px;background:#bcccdc;transform:translateX(-50%);border-radius:2px;z-index:2;}
    .bar{position:absolute;z-index:1;height:100%;left:0;top:0;
      background:linear-gradient(90deg,var(--rojo),var(--amarillo) 39%,var(--verde) 61%);
      border-radius:12px;width:50%;transition:width 0.11s linear;}
    .cents{font-weight:700;margin-top:10px;}
    .status{margin-top:13px;font-weight:700; font-size:1.18rem; min-height:28px;}
    .hint{color:var(--muted);font-size:0.96rem;text-align:center;margin-top:16px;}
    @media(max-width:650px){
      .wrap{padding:4px;}
      .main-card{padding:11px 5vw 13px;}
      .gauge{width:100%;}
      .controls{flex-direction:column;gap:11px;}
      .status{font-size:1.09rem;}
      .strings-bar{margin-bottom:12px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a href="herramientas.html" class="back-btn" aria-label="Volver">‚Üê</a>
      <h1>Afinador de guitarra</h1>
    </header>
    <div class="main-card">
      <div class="strings-bar" id="stringsBar">
        <button class="string-btn" data-note="E4" data-freq="329.63"><span>1</span><small>E</small></button>
        <button class="string-btn" data-note="B3" data-freq="246.94"><span>2</span><small>B</small></button>
        <button class="string-btn" data-note="G3" data-freq="196.00"><span>3</span><small>G</small></button>
        <button class="string-btn" data-note="D3" data-freq="146.83"><span>4</span><small>D</small></button>
        <button class="string-btn selected" data-note="A2" data-freq="110.00"><span>5</span><small>A</small></button>
        <button class="string-btn" data-note="E2" data-freq="82.41"><span>6</span><small>E</small></button>
      </div>
      <div class="controls">
        <button id="startBtn" class="btn">üé§ Iniciar</button>
        <button id="stopBtn" class="btn ghost">‚èπ Detener</button>
      </div>
      <section class="tuner">
        <div style="color:#a8b7c9;">Objetivo</div>
        <div id="targetLabel" class="note-big">A2</div>
        <div id="targetFreq" class="freq">110.00 Hz</div>
        <div style="height:9px;"></div>
        <div>Detectado</div>
        <div id="detectedNote" class="note-big">‚Äî</div>
        <div id="detectedFreq" class="freq">‚Äî Hz</div>
        <div class="gauge">
          <div class="mark"></div>
          <div id="gaugeBar" class="bar"></div>
        </div>
        <div id="centsText" class="cents">‚Äî cents</div>
        <div id="tuneStatus" class="status">Sin se√±al</div>
        <div class="hint">Selecciona una cuerda arriba y empieza a afinar.<br>
          Cuando est√© afinada escuchar√°s un <b>¬°tin!</b> de confirmaci√≥n.</div>
      </section>
    </div>
  </div>
  <audio id="tinSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_115b9d5c48.mp3"></audio>
  <script>
    // Botones de cuerdas arriba
    const stringBtns = Array.from(document.querySelectorAll('.string-btn'));
    let currentTarget = {note:"A2",freq:110.00};
    function setTarget(note,freq){
      currentTarget = {note, freq};
      document.getElementById('targetLabel').textContent=note;
      document.getElementById('targetFreq').textContent=freq.toFixed(2) + ' Hz';
    }
    stringBtns.forEach(btn=>{
      btn.addEventListener('click',()=>{
        stringBtns.forEach(x=>x.classList.remove('selected'));
        btn.classList.add('selected');
        setTarget(btn.dataset.note, parseFloat(btn.dataset.freq));
      });
    });

    // Sonido de "tin" cuando afina
    const tinSound = document.getElementById('tinSound');
    let lastTin=0;

    // Afinador funcional
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const detectedNote = document.getElementById('detectedNote');
    const detectedFreq = document.getElementById('detectedFreq');
    const gaugeBar = document.getElementById('gaugeBar');
    const centsText = document.getElementById('centsText');
    const tuneStatus = document.getElementById('tuneStatus');

    let audioCtx, analyser, micSource, stream, buffer, raf;
    let lastStatus = "";
    let lastTimeTin= 0;

    async function startMic(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({audio:true});
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        micSource = audioCtx.createMediaStreamSource(stream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize=2048;
        buffer=new Float32Array(analyser.fftSize);
        micSource.connect(analyser);
        update();
      }catch(e){alert("Activa el micr√≥fono en tu navegador :)");}
    }

    function stopMic(){
      if(raf)cancelAnimationFrame(raf);
      if(stream)stream.getTracks().forEach(t=>t.stop());
      tuneStatus.textContent = "Detenido"; tuneStatus.style.color="var(--muted)";
      gaugeBar.style.width="50%";
      detectedNote.textContent="‚Äî"; detectedFreq.textContent="‚Äî Hz"; centsText.textContent="‚Äî cents";
    }

    function update(){
      analyser.getFloatTimeDomainData(buffer);
      const pitch = autoCorrelate(buffer,audioCtx.sampleRate);
      if(pitch>0){
        detectedFreq.textContent=pitch.toFixed(2)+" Hz";
        detectedNote.textContent=freqToNoteName(pitch);
        const cents=1200*Math.log2(pitch/currentTarget.freq);
        centsText.textContent=(cents>0?"+":"")+Math.round(cents)+" cents";
        const pct=50+(Math.max(-100,Math.min(100,cents))/200)*100;
        gaugeBar.style.width=pct+"%";

        if(Math.abs(cents)<=5){
          tuneStatus.textContent="¬°Afinada! ‚úì";
          tuneStatus.style.color="var(--verde)";
          // Emite "tin" (sin spam: m√°x 1 vez cada 1.3s)
          if(Date.now()-lastTimeTin>1300){ tinSound.currentTime=0; tinSound.play(); lastTimeTin=Date.now();}
        }
        else if(Math.abs(cents)<=15){
          tuneStatus.textContent="Casi ‚úì";
          tuneStatus.style.color="var(--amarillo)";
        }
        else{
          tuneStatus.textContent="Desafinado ‚úó";
          tuneStatus.style.color="var(--rojo)";
        }
      }else{
        detectedNote.textContent="‚Äî"; detectedFreq.textContent="‚Äî Hz"; centsText.textContent="‚Äî cents";
        tuneStatus.textContent="Sin se√±al";
        tuneStatus.style.color="var(--muted)";
        gaugeBar.style.width="50%";
      }
      raf=requestAnimationFrame(update);
    }

    // Utilidad: apretar 'm' inicia, 's' detiene.
    window.addEventListener('keydown',e=>{
      if(e.key.toLowerCase()==='m')startMic();
      if(e.key.toLowerCase()==='s')stopMic();
    });

    // Pitch detection: autocorrelaci√≥n simple.
    function autoCorrelate(buf,sr){
      let SIZE=buf.length, rms=0; for(let i=0;i<SIZE;i++)rms+=buf[i]*buf[i];
      rms=Math.sqrt(rms/SIZE); if(rms<0.01)return -1;
      let r1=0,r2=SIZE-1,th=0.2;
      while(r1<SIZE/2 && Math.abs(buf[r1])<th)r1++;
      while(r2>SIZE/2 && Math.abs(buf[r2])<th)r2--;
      buf=buf.slice(r1,r2); SIZE=buf.length;
      const c=new Array(SIZE).fill(0);
      for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE-i;j++)c[i]+=buf[j]*buf[j+i];
      let d=0;while(c[d]>c[d+1])d++;
      let maxval=-1,maxpos=-1; for(let i=d;i<SIZE;i++)if(c[i]>maxval){maxval=c[i];maxpos=i;}
      let a=(c[maxpos-1]+c[maxpos+1]-2*c[maxpos])/2;
      let b=(c[maxpos+1]-c[maxpos-1])/2;
      return sr/(maxpos-(b/(2*a)));
    }

    // Nota a partir de frecuencia
    const NOTE_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    function freqToNoteName(freq){
      if(!freq||freq<=0)return '‚Äî';
      const noteNum=12*(Math.log(freq/440)/Math.log(2))+69;
      const rounded=Math.round(noteNum);
      const noteIndex=(rounded%12+12)%12;
      const octave=Math.floor(rounded/12)-1;
      return NOTE_NAMES[noteIndex]+octave;
    }

    // Inicializa estado UI
    setTarget(currentTarget.note,currentTarget.freq);
    startBtn.onclick=startMic;
    stopBtn.onclick=stopMic;
  </script>
</body>
</html>
